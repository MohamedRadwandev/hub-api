<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
      crossorigin="anonymous"
    />
    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
        padding-left: 10px;
      }
    </style>
  </head>
  <body>
    <div id="floating-panel">
      <div class="form-check">
        <input
          class="form-check-input"
          type="checkbox"
          id="hs-parent-company"
        />
        <label class="form-check-label" for="hs-parent-company">
          hs parent company id
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="in-store-display" />
        <label
          class="form-check-label"
          style="float: left"
          for="in-store-display"
          >in store display</label
        >
      </div>
    </div>
    <div id="map"></div>
    <script
      type="text/javascript"
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"
    ></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCg06XnKwnvtkV5_guoRKiHmuLar0UHCXE&callback=initMap&libraries=&v=weekly"
      defer
    ></script>

    <script>
      $(document).ready(function () {
        $.post(
          "https://google-map-habspot.herokuapp.com/companies",

          {
            inStoreDisplay: document.querySelector("#in-store-display").checked,
            hsParentCompany: document.querySelector("#hs-parent-company")
              .checked,
          },
          function (result) {
            const jsData = JSON.parse(result);
            setMapOnAll(null);
            jsData.results.forEach((item) => {
              geocodeAddress(geocoder, map, item.properties.address);
            });
          }
        );

        $("#hs-parent-company, #in-store-display").change(function () {
          $.post(
            "https://google-map-habspot.herokuapp.com/companies",

            {
              inStoreDisplay: document.querySelector("#in-store-display")
                .checked,
              hsParentCompany: document.querySelector("#hs-parent-company")
                .checked,
            },
            function (result) {
              const jsData = JSON.parse(result);
              setMapOnAll(null);
              jsData.results.forEach((item) => {
                if (
                  document.querySelector("#in-store-display").checked ===
                    true &&
                  document.querySelector("#hs-parent-company").checked === true
                ) {
                  if (
                    item.properties.in_store_display ||
                    item.properties.hs_parent_company_id
                  ) {
                    geocodeAddress(geocoder, map, item.properties.address);
                  }
                }

                if (
                  document.querySelector("#in-store-display").checked ===
                    true &&
                  document.querySelector("#hs-parent-company").checked === false
                ) {
                  if (item.properties.in_store_display) {
                    geocodeAddress(geocoder, map, item.properties.address);
                  }
                }
                if (
                  document.querySelector("#in-store-display").checked ===
                    false &&
                  document.querySelector("#hs-parent-company").checked === true
                ) {
                  if (item.properties.hs_parent_company_id) {
                    geocodeAddress(geocoder, map, item.properties.address);
                  }
                }
              });
            }
          );
        });

        // $.get("http://localhost:3000/companies", function(data, status){
        //   	const jsData = JSON.parse(data);
        //   	console.log("data coming",jsData.results);

        //   	jsData.results.forEach(item=>{
        //   		geocodeAddress(geocoder, map,item.properties.address)
        //   	})
        //     // console.log("Data: " + data + "\nStatus: " + data);
        //   });

        //  	$.ajax({
        //   url: 'http://localhost:3000/companies',
        //   type: 'post', // performing a POST request
        //   data : {
        //     inStoreDisplay : false,
        //     hsParentCompany : document.querySelector("#hs-parent-company")
        //   },
        //   dataType: 'json',
        //   success: function(data)
        //   {
        //     const jsData = JSON.parse(data);
        //     	console.log("data coming",jsData.results);
        //     	jsData.results.forEach(item=>{
        //     		geocodeAddress(geocoder, map,item.properties.address)
        //     	})
        //   }
        // });

        function getData() {
          // 	 $.ajax({
          //   url: 'http://localhost:3000/companies',
          //   type: 'post', // performing a POST request
          //   data : {
          //     inStoreDisplay : false,
          //     hsParentCompany : document.querySelector("#hs-parent-company");
          //   },
          //   dataType: 'json',
          //   success: function(data)
          //   {
          //     const jsData = JSON.parse(data);
          //     	console.log("data coming",jsData.results);
          //     	jsData.results.forEach(item=>{
          //     		geocodeAddress(geocoder, map,item.properties.address)
          //     	})
          //   }
          // });
        }
      });
      let initialLocation;
      navigator.geolocation.getCurrentPosition(function (position) {
        initialLocation = new google.maps.LatLng(
          position.coords.latitude,
          position.coords.longitude
        );
        map.setCenter(initialLocation);
      });
      let map, geocoder, marker;
      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 5,
          center: initialLocation || { lat: -34.397, lng: 150.644 },
        });
        geocoder = new google.maps.Geocoder();
      }

      let markers = [];

      function geocodeAddress(geocoder, resultsMap, address) {
        // const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === "OK") {
            console.log("ok", address);

            // resultsMap.setCenter(results[0].geometry.location);

            marker = new google.maps.Marker({
              map: resultsMap,
              position: results[0].geometry.location,
            });
            markers.push(marker);
          } else {
            console.log(
              "Geocode was not successful for the following reason: " + address
            );
          }
        });
      }

      function setMapOnAll(map) {
        for (let i = 0; i < markers.length; i++) {
          markers[i].setMap(map);
        }
      }
    </script>
  </body>
</html>
